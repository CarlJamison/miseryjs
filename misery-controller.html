<!DOCTYPE html>
<html>
<head>
<title>MiseryJS</title>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://unpkg.com/jquery.terminal/js/jquery.terminal.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
<link rel="stylesheet" href="https://unpkg.com/jquery.terminal/css/jquery.terminal.min.css"/>
<script src="/socket.io/socket.io.js"></script>
<style>
    .current-connection{
        background-color: #005497 !important;
        color: #d6d6d6;
    }
</style>
</head>
<body style="display: flex; height: 100%; margin: 0;">
    <div style="flex: 50" class="cli"></div>
    <div style="max-width: 50%; flex: 50; letter-spacing: 1.25px; padding: 16px; background-color: whitesmoke;" class="connections"></div>
    <script>
        var currentId = "";
        var socket = null;
        var stage = 0;
        var cCount = 0;
        var commands = [];

        $.getJSON("commands.json", function(json) {
            commands = json.commands;
        });

        var terminal = $('div.cli').terminal([{
            login: (username, password) => {
                if(socket){
                    this.echo("connection already exists");
                    return;
                }
                socket = io({auth: {token: password}});
                initializeSocket();
            },
            send: function(message) {
                if(noConnection()) return;
                this.echo('Message sent');
                socket.emit('message', message);
                const jsConfetti = new JSConfetti()
                jsConfetti.addConfetti()
            },
            echo: message => {
                if(noConnection()) return;
                socket.emit('echo', {id: currentId, message});
            },  
            load: message => {
                if(noConnection()) return;
                socket.emit('load', {id: currentId, fileName: message});
            },
            run: function(...args) {
                if(noConnection()) return;
                socket.emit('run-task', {id: currentId, args: args.map(a => a.toString())});
            },
            execute_assembly: function(...args) {
                if(noConnection()) return;
                socket.emit('execute-assembly', {id: currentId, args: args.map(a => a.toString())});
            }
        }, input => {
            var command = commands.find(c => c.name == input);
            if(command){
                terminal.exec(command.action);
            }
        }], {
            completion: true,            
            checkArity: false,
            greetings: 'Welcome to misery controller'
        });

        function noConnection(){
            if(!socket){
                terminal.echo("no connection");
            }
            return !socket;
        }

        function initializeSocket(){

            socket.on("disconnect", () => {
                terminal.echo('connection failed');
                socket = null;
            });

            socket.on("echo", message => {
                terminal.echo(message);
            });

            socket.on("latency-update", update => {
                $(`#latency${update.id}`).html(
                    `<div style="padding-bottom: 4px;" id="latency${update.id}"><span style="text-transform: capitalize">Latency: </span>${update.latency} ms</div>`
                )
            });

            socket.on("connections", connections => {

                if(cCount < connections.length){
                    const jsConfetti = new JSConfetti();
                    jsConfetti.addConfetti();
                }
                cCount = connections.length;

                $("div.connections").html(connections.length + " open connections");

                connections.forEach(element => {
                    var contentString = "";
                    Object.keys(element).forEach(p => {
                        contentString += `<div style="padding-bottom: 4px;"><span style="text-transform: capitalize">${p}: </span>${element[p]}</div>`
                    });
                    contentString += `<div style="padding-bottom: 4px;" id="latency${element.socketId}"><span style="text-transform: capitalize">Latency: </span>Unknown</div>`
                    $("div.connections").append(`<div class="connection-button" id="${element.id}"
                    style="padding: 16px; background-color: whitesmoke; cursor: pointer; border-radius: 5px;
                    box-shadow: darkgrey 2px 3px 8px -4px; margin-top: 16px;">${contentString}</div>`);
                });
                $("div.connection-button").click(function(){
                    
                    if(currentId && currentId.length) $(`#${currentId}`).removeClass("current-connection");
                    currentId = this.id;
                    $(`#${currentId}`).addClass("current-connection");
                    terminal.set_prompt(currentId + "[[gb;red;black]>] ");
                });

            });
        }
        </script>
</body>
</html>